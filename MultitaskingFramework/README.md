# Interrupt-Based Multitasking Framework for Arduino
The files in this directory comprise an attempt at an organized, blocking-friendly code space for an Arduino program with subroutines that may need to be executed in a nonlinear fashion.
## How to Use It
The main code space of the framework is located in the `main.h` file. This file presents a familiar `int Main()` function alongside several callback functions that are internally interrupt-driven within `MultitaskingFramework.ino`:
- `int Main()` - Code within this function may block and may contain infinite loops (the function is never required to return). In the functions that follow, non-blocking code is required.
- `inline void Draw(unsigned long frame)` - This function is called repeatedly at regular intervals. `frame` is a counter provided to make timing, animations, and smooth transitions easier. By default, this function is called 16 times per second; a helper function implementing rate control is forthcoming.
- `inline void IO(unsigned long deltaT, byte deltaB, byte deltaD)` - This function is called any time a registered IO pin changes state. IO pins can be registered with the `registerIOPins(...)` function. Within the ATmega328P microcontroller at the heart of the Arduino, IO pins are organized into 8-bit ports: Port D corresponds to pins 0 through 7, and port B corresponds to pins 8 through 13 (the remaining bits are unused). The parameters `deltaB` and `deltaD` use the binary representations of these ports to describe which pin has changed states: If a pin's state is the same as it was last time `IO()` was called, the corresponding bit in `deltaX` is 0 (where X depends upon which port contains the pin); if the pin's state has changed, the corresponding bit in `deltaX` is 1.
![Arduino port mapping diagram](https://images.prismic.io/circuito/e57c56f68189f03145726786306d6a8ca7168571_arduino-uno-pinout-digital-pins-pwm-1.png?auto=compress,format)
In the above image, the labels `PBx`, `PCx`, and `PDx` show how the Arduino's pins map to the ports of the ATmega328P MCU. Digital port C is shared with the analog input pins, so using it for digital inputs is a waste of functionality if other digital-only pins are available.
- `inline void SerialEvent()` - This function is called whenever serial data is available to read. Simply put, sending text to the Arduino via the Serial Monitor will cause this function to be called. Ideally, the code within this function will consume (read) all the available data in the serial buffer before returning, but it will be called repeatedly after `Draw()` until all the available serial data has been consumed.
## Why is everything in header files?
The Arduino's compiler does not handle multiple files well. Compilation of multiple `.cpp` files is only supported within a `src` subdirectory, and when I attempted to do so, any compilation errors had a chance of creating a duplicate file within the main directory that broke future compilation attempts and had to be fixed manually. The best solution I have found to this issue so far is simply to implement everything directly in the header files.
